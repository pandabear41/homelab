- name: Install Calico
  kubernetes.core.helm:
    name: calico
    chart_ref: tigera-operator
    chart_repo_url: "{{ calico_repo_url }}"
    chart_version: "{{ calico_version }}"
    release_namespace: "{{ calico_namespace }}"
    values: "{{ calico_values }}"

# - name: Wait for Cilium CRDs
#   kubernetes.core.k8s_info:
#     kind: CustomResourceDefinition
#     name: "{{ item }}"
#   loop:
#     - ciliuml2announcementpolicies.cilium.io
#     - ciliumloadbalancerippools.cilium.io
#   register: crd
#   until: crd.resources | length > 0
#   retries: 5
#   delay: 10

# - name: Apply Cilium resources
#   kubernetes.core.k8s:
#     template: "{{ item }}"
#   loop:
#     - ciliuml2announcementpolicy.yaml
#     - ciliumloadbalancerippool.yaml